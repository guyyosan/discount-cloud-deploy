name: Release
on:
    push:

jobs:
    docker-release:
        name: Tagged Docker release to Google Artifact Registry
        runs-on: [self-hosted]
        # if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags') # <-- Notice that I'm filtering here to only run when a tagged commit is pushed

        permissions:
            contents: "read"
            id-token: "write"

        steps:
            - id: checkout
              name: Checkout
              uses: actions/checkout@v2

            - id: buildx_setup
              name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - id: auth
              name: Authenticate with Google Cloud
              uses: google-github-actions/auth@v0
              with:
                  token_format: access_token
                  workload_identity_provider: projects/885403030145/locations/global/workloadIdentityPools/gh-pool/providers/gh-provider
                  service_account: gke-builder@community-poc-370208.iam.gserviceaccount.com
                  access_token_lifetime: 3000s

            - name: Login to Artifact Registry
              uses: docker/login-action@v1
              with:
                  registry: us-central1-docker.pkg.dev
                  username: oauth2accesstoken
                  password: ${{ steps.auth.outputs.access_token }}

            - name: Get tag
              id: get-tag
              run: echo ::set-output name=short_ref::${GITHUB_REF#refs/*/}

            - name: Build and export to Docker
              uses: docker/build-push-action@v5
              with:
                  context: .
                  load: true
                  tags: community-api:test
                  cache-from: type=registry,ref=us-central1-docker.pkg.dev/community-poc-370208/demo/community-api:buildcache
                  cache-to: type=registry,ref=us-central1-docker.pkg.dev/community-poc-370208/demo/community-api:buildcache,mode=max

            - name: Test
              run: |
                  docker run --entrypoint=pytest community-api:test -v .

            - id: docker-push-tagged
              name: Tag Docker image and push to Google Artifact Registry
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: true
                  tags: |
                      us-central1-docker.pkg.dev/community-poc-370208/demo/community-api:${{ steps.get-tag.outputs.short_ref }}
                      us-central1-docker.pkg.dev/community-poc-370208/demo/community-api:latest
